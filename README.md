# Очередь Заданий (tksva_q) информационного ресурса службы внутреннего аудита (ИРСВА)

### Назначение ИРСВА
ИРСВА предназначен для организации системы непрерывного аудита.
На данном этапе развития ИРСВА предназначен для автоматизации контроля актирования выручки.
Ресурс по запросу пользователя предоставляет информацию о заказах в которых с большой вероятностью не учтена выручка по той или иной услуге.

### Доступ к ИРСВА
Пользователи ИРСВА - сотрудники ПАО Трансконтейнер отвечающие за учет выручки по той или иной услуге.
Пользовательский доступ к ресурсу осуществляется через веб-браузер через указание в адресной строке IP сервера, на котором развернута система.
Доступ возможен только с рабочих станций зарегистрированных в домене Трансконтейнера.  
Планируется регистрация субдомена sva.trcont.com для организации более удобного доступа.

### Состав ИРСВА
ИРСВА состоит из трех работающих параллельно систем:
- Инспектор (tksva_p). Система автоматически обновляет источники данных для поддержания их актаульности.
- Очередь Заданий (tksva_q). Система принимает от пользователей задания на выгрузку данных необходимых им для анализа, запускает скрипты формирующие выгрузки и по мере формирования выгрузок предоставляет доступ к ним.
- Веб-интерфейс (tksva). Система позволяет отправлять в Очередь Заданий задачи пользователей на подготовку и выгрузку данных и по по мере формирования выгрузок, скачивать их на локальную машину пользователя.

Системы работают на сервере под управлением ОС Linux, обмен информацией между системами осуществляется с помощью БД Postgresql.
Код и инструкции по развёртыванию каждой системы хранятся в отдельном репозитории.

Данный репозиторий относится к Очереди Заданий (tksva_q).
Репозитарии Инспектора (tksva_p) и Веб-интерфейса (tksva) доступны по ссылкам:
- [Инспектор (tksva_p)](https://github.com/DSTsvetkovTRCONT/tksva_p)
- [Веб-интерфейс (tksva)](https://github.com/DSTsvetkovTRCONT/tksva)

#### Описание алгоритма
На данном этапе развития проекта очередь может обрабатывать два вида задач:
- выгрузка из таблицы DWH ***audit._sales__execution_orders*** с отбором по начальной и конечной дате и станции отправления (формируется на основании параметров переданных через форму **DownloadForStationForm** Веб-интерфейса tksva).
- выгрузка из таблицы DWH ***audit._sales__execution_orders*** с отбором по начальной и конечной дате и дороге отправления (формируется на основании параметров переданных через форму **DownloadForRailwayForm** Веб-интерфейса tksva).

Очередь заданий запускается в качестве сервиса (службы) линукс.

Очередь раз в секунду проверяет наличие выгрузок, которые были скачаны пользователем на локальную рабочую станцию, а так же наличие выгрузок подготовленных, но не скачанных в течение 72 часов с момента готовности (переенная **HOW_MANY_HOURS_TO_STORE** файла ***.env***) и удаляет эти выгрузки из хранилища подготовленных выгрузок.  
Статус задачи для таких выгрузок в таблице post БД postgresql устанавливается **"скрыта менеджером очереди"**.

Затем Очередь Заданий проверяет наличие задач ожидающих запуска на выплнение (такие задачи имеют статус **"в очереди"** в таблице post БД Postgresql) и запускает эти задачи.  
Первой запускаются задача попавшая в очередь раньше других.  
При запуске задачи таблица DWH ***audit._sales__execution_orders*** блокируется от замены на сформированную таблицу DWH ***audit._sales__execution_orders_tmp*** (см. описание работы Инспектора tksva_p) для предотвращения нарушения целостности выгружаемых данных. Для этого в БД Postgesql в таблице ***dwh_tables_info*** значение поля ***gives_information*** устанавливается равным **True**. После выполнения задачи таблица DWH ***audit._sales__execution_orders*** доступна для замены (поле ***gives_information*** устанавливается равным **False**). 

Скрипты для подготовки выгрузок хранятся в виде функций в модуле ***processings.py***. Функции обработки называются так же как объекты формы модуля ***forms.py*** системы tksva в которой задаются входные параметры для соответствующей обработки.

Скрипты выполняются поэтапно, фрагментами, размер которых задаётся переменной **CHUNK_SIZE** файла ***.env***, что даёт возможность настроить выполнение скриптов в соответствии с возможностями сервера на котором развернута ИРСВА и возможностями DWH.  
Статус задачи устанавливается в **"загружено n из m"**. По окончании подготовки выгрузки устанавливается статус задачи **"файл подготовлен"**.  

#### Инструкция по развертыванию
На производственном сервере в домашней директории ползователя создаём директорию ***tksva_q*** в которую копируем все файлы репозитория.
В директории ***~/tksva_p*** создаём файл ***.env*** по образцу файла ***.envexample***.
Системы ИРСВА Веб-интерфейс (tksva) и Очередь заданий (tksva_q) должны быть установлены на одном и том же сервере, в домашней директории одного и того же пользователя.

Обновляем пакеты:
```bash
sudo apt update
sudo apt -y upgrade
```
Устанавливаем пакет venv (если не был установлен ранее):
```bash
sudo apt install python3-venv
```
В директории tksva_p создаём и активируем виртуальное окружение:
```bash
cd ~/tksva_p
python3 -m venv .venv
source .venv/bin/activate
```
Из файла requirements.txt устанавливаем зависимости:
```bash
pip install -r requirements.txt
```
Отключаем виртуальную среду:
```bash
deactivate
```
Создаём сервис Linux:
```bash
sudo nano /etc/systemd/system/tksva_q.service
```
```
[Unit]
Description=Очередь для tksva
After=multi-user.target

[Service]
User=username
WorkingDirectory=/home/<username>/tksva_q
Group=www-data
Restart=always
ExecStart=/home/<username>/tksva_q/.venv/bin/python3 /home/<username>/tksva_q/queue_manager.py

[Install]
WantedBy=multi-user.target
```
Запускаем сервис, настраиваем его автозапуск:
```bash
sudo systemctl start tksva_q
sudo systemctl enable tksva_q
```